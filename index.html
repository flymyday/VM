<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VN OneFile Integrated (No React / No Build)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{font-family:'Apple SD Gothic Neo','Malgun Gothic',sans-serif;overflow:hidden}
    .scroll-custom::-webkit-scrollbar{width:6px}
    .scroll-custom::-webkit-scrollbar-thumb{background:#4b5563;border-radius:3px}
    .scroll-custom::-webkit-scrollbar-track{background:#1f2937}
    input,textarea,select{font-size:14px!important;background:#111827;color:#fff;border-color:#374151}
    .file-input-wrapper{position:relative;overflow:hidden;display:inline-block;cursor:pointer}
    .file-input-wrapper input[type=file]{position:absolute;left:0;top:0;opacity:0;width:100%;height:100%;cursor:pointer}
    #preview-frame-container{transition:all .2s ease}
    .mode-landscape{width:100%;height:100%}
    .mode-portrait{width:360px;height:640px;border:4px solid #333;border-radius:20px;box-shadow:0 0 20px rgba(0,0,0,.5)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  </style>
</head>

<body class="bg-gray-900 text-white h-screen flex">

  <!-- Sidebar -->
  <aside class="w-80 bg-gray-800 border-r border-gray-700 flex flex-col h-full">
    <div class="p-4 border-b border-gray-700 bg-gray-900">
      <div class="text-lg font-bold text-pink-500">VN OneFile</div>
      <div class="text-xs text-gray-400">Visual(Prompt) + Game Maker + Preview</div>
    </div>

    <div class="p-3 border-b border-gray-700 space-y-2">
      <div class="flex gap-2">
        <button id="tabGame" class="flex-1 py-2 rounded bg-pink-600 text-sm font-bold">Game Maker</button>
        <button id="tabVisual" class="flex-1 py-2 rounded bg-gray-700 hover:bg-gray-600 text-sm font-bold">Visual Maker</button>
      </div>

      <div class="grid grid-cols-2 gap-2">
        <div>
          <label class="text-[10px] text-gray-400">í”„ë¡œì íŠ¸ ì´ë¦„</label>
          <input id="projectName" class="w-full px-2 py-1 rounded border text-xs" value="MyVN">
        </div>
        <div>
          <label class="text-[10px] text-gray-400">ê²Œì„ íƒ€ì´í‹€</label>
          <input id="gameTitle" class="w-full px-2 py-1 rounded border text-xs" value="My Visual Novel">
        </div>
      </div>

      <div class="grid grid-cols-2 gap-2">
        <div>
          <label class="text-[10px] text-gray-400">ê¸€ê¼´</label>
          <select id="fontSel" class="w-full px-2 py-1 rounded border text-xs">
            <option value="sans" selected>ê³ ë”•</option>
            <option value="serif">ëª…ì¡°</option>
            <option value="cursive">ì†ê¸€ì”¨</option>
          </select>
        </div>
        <div>
          <label class="text-[10px] text-gray-400">íƒ€ì´í‹€ íš¨ê³¼(ë„¤ì˜¨ ì œì™¸)</label>
          <select id="titleStyleSel" class="w-full px-2 py-1 rounded border text-xs">
            <option value="glow" selected>glow</option>
            <option value="paper">paper</option>
            <option value="minimal">minimal</option>
            <option value="romantic">romantic</option>
            <option value="sleek">sleek</option>
            <option value="classic">classic</option>
            <option value="sparkle">sparkle</option>
            <option value="outline">outline</option>
  <option value="gold">gold</option>
  <option value="glass">glass</option>
  <option value="luxury">luxury</option>
  <option value="subtle">subtle</option>
          </select>
        </div>
      </div>

            <div class="grid grid-cols-1 gap-2">
        <button id="btnNewProject" class="py-2 bg-red-600 hover:bg-red-700 rounded text-xs font-bold">
          ìƒˆ í”„ë¡œì íŠ¸
        </button>
      </div>

<div class="grid grid-cols-2 gap-2">
        <button id="btnSaveProject" class="py-2 bg-indigo-600 hover:bg-indigo-700 rounded text-xs font-bold">ì €ì¥(.json)</button>
        <label class="file-input-wrapper py-2 bg-gray-600 hover:bg-gray-500 rounded text-xs font-bold text-center">
          ë¶ˆëŸ¬ì˜¤ê¸°
          <input id="loadProjectFile" type="file" accept=".json">
        </label>
      </div>

      <div class="grid grid-cols-2 gap-2">
        <button id="btnExportData" class="py-2 bg-green-600 hover:bg-green-700 rounded text-xs font-bold">data.json</button>
        <button id="btnPreview" class="py-2 bg-gray-700 hover:bg-gray-600 rounded text-xs font-bold border border-gray-600">ë¯¸ë¦¬ë³´ê¸°</button>
      </div>

      <div class="text-[10px] text-yellow-300/80 leading-snug pt-2 border-t border-gray-700 text-center">
        ê·œì¹™: <b>ì„¸ë¡œë§Œ ë‹¨ë… ë¶ˆê°€</b><br>
        (ê°€ë¡œë§Œ ë˜ëŠ” ê°€ë¡œ+ì„¸ë¡œë§Œ í—ˆìš©)
      </div>

      <div id="status" class="text-[10px] text-gray-300 text-center"></div>
    </div>

    <!-- Scene list -->
    <div class="flex-1 overflow-y-auto p-2 scroll-custom" id="sceneList"></div>

    <div class="p-3 border-t border-gray-700 bg-gray-800 space-y-2">
      <button id="btnAddScene" class="w-full py-2 border-2 border-dashed border-gray-600 rounded-lg text-gray-300 hover:border-pink-500 hover:text-pink-400 transition-colors text-sm font-bold">
        + ìƒˆ ì¥ë©´
      </button>
    </div>
  </aside>

  <!-- Main -->
  <main class="flex-1 min-w-0 h-full relative">
    <!-- Game Maker Panel -->
    <section id="panelGame" class="h-full overflow-y-auto scroll-custom p-6">
      <div class="max-w-5xl mx-auto space-y-6 pb-24">

        <div class="flex items-center justify-between">
          <div class="text-xl font-bold">
            <span class="bg-pink-600 px-2 py-1 rounded text-xs" id="activeSceneBadge">Scene 1</span>
            <span class="text-gray-300 text-sm ml-2">í¸ì§‘</span>
          </div>
          <div class="text-xs text-gray-400 hidden md:block">
            ë³€ìˆ˜ ì¹˜í™˜: <span class="mono text-yellow-300">{{player}}</span>
          </div>
        </div>

        <!-- Scene Mode -->
        <div class="bg-gray-800 border border-gray-700 rounded-xl p-4 space-y-3">
          <div class="flex items-center justify-between">
            <div class="text-sm font-bold text-cyan-300">ì¥ë©´ íƒ€ì…</div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div class="bg-gray-900 border border-gray-700 rounded p-3">
              <label class="text-xs text-gray-400">íƒ€ì…</label>
              <select id="sceneType" class="w-full mt-1 p-2 rounded border">
                <option value="normal" selected>ì¼ë°˜ ì¥ë©´(ëŒ€ì‚¬/ì„ íƒì§€)</option>
                <option value="title">íƒ€ì´í‹€ ì¹´ë“œ(í”„ë ˆì„+í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´)</option>
              </select>
              <div class="text-[10px] text-gray-500 mt-2">
                íƒ€ì´í‹€ ì¹´ë“œëŠ” â€œì´ë¯¸ì§€ì— í…ìŠ¤íŠ¸ ë„£ì§€ ì•ŠìŒâ€. í…ìŠ¤íŠ¸ëŠ” ì—”ì§„ì´ ì˜ˆì˜ê²Œ ë Œë”ë§í•©ë‹ˆë‹¤.
              </div>
            </div>

            <div class="bg-gray-900 border border-gray-700 rounded p-3 space-y-2">
              <div class="text-xs text-gray-400">íƒ€ì´í‹€ ì¹´ë“œ ì˜µì…˜</div>
              <div class="grid grid-cols-2 gap-2">
                <div>
                  <label class="text-[10px] text-gray-400">ì œëª©</label>
                  <input id="titleText" class="w-full px-2 py-1 rounded border text-xs" placeholder="EP.01 ì²« ë§Œë‚¨">
                </div>
                <div>
                  <label class="text-[10px] text-gray-400">ë¶€ì œ</label>
                  <input id="subtitleText" class="w-full px-2 py-1 rounded border text-xs" placeholder="Prologue">
                </div>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <div>
                  <label class="text-[10px] text-gray-400">ì•ˆì „ì˜ì—­</label>
                  <select id="safeAreaPos" class="w-full px-2 py-1 rounded border text-xs">
                    <option value="center" selected>ì¤‘ì•™</option>
                    <option value="top">ìƒë‹¨</option>
                  </select>
                </div>
                <div>
                  <label class="text-[10px] text-gray-400">í”„ë ˆì„ ê°•ë„</label>
                  <select id="frameIntensity" class="w-full px-2 py-1 rounded border text-xs">
                    <option value="subtle" selected>ì•½</option>
                    <option value="medium">ì¤‘</option>
                    <option value="strong">ê°•</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Backgrounds -->
        <div class="bg-gray-800 border border-gray-700 rounded-xl p-4 space-y-3">
          <div class="flex items-center justify-between">
            <div class="text-sm font-bold text-blue-300">ë°°ê²½ ì—…ë¡œë“œ</div>
            <div class="text-[10px] text-gray-400 hidden md:block">
              ê°€ë¡œë§Œ ìˆìœ¼ë©´ ì„¸ë¡œì—ì„œ cover í¬ë¡­ìœ¼ë¡œ ì‚¬ìš©
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-gray-900 p-3 rounded border border-gray-700 flex gap-3 items-center">
              <div id="prevLand" class="w-20 h-12 bg-black border border-gray-600 bg-cover bg-center rounded shrink-0"></div>
              <div class="flex-1">
                <div class="text-xs text-gray-300 font-bold">ğŸ’» ê°€ë¡œ ë°°ê²½</div>
                <label class="file-input-wrapper w-full bg-gray-700 hover:bg-gray-600 text-center py-1.5 rounded border border-gray-600 text-xs mt-1">
                  ì—…ë¡œë“œ
                  <input type="file" accept="image/*" id="bgLandFile">
                </label>
              </div>
            </div>

            <div class="bg-gray-900 p-3 rounded border border-gray-700 flex gap-3 items-center relative overflow-hidden">
              <div class="absolute top-0 right-0 bg-pink-600 text-[9px] px-1.5 py-0.5 rounded-bl font-bold">Shorts</div>
              <div id="prevPort" class="w-8 h-12 bg-black border border-gray-600 bg-cover bg-center rounded shrink-0 flex items-center justify-center text-[8px] text-gray-500">PC</div>
              <div class="flex-1">
                <div class="text-xs text-gray-300 font-bold">ğŸ“± ì„¸ë¡œ ë°°ê²½(ì„ íƒ)</div>
                <label class="file-input-wrapper w-full bg-gray-700 hover:bg-gray-600 text-center py-1.5 rounded border border-gray-600 text-xs mt-1">
                  ì—…ë¡œë“œ
                  <input type="file" accept="image/*" id="bgPortFile">
                </label>
              </div>
            </div>
          </div>

          <div class="text-[10px] text-gray-400">
            * ê·œì¹™: ì„¸ë¡œ ë°°ê²½ë§Œ ë‹¨ë… ë¶ˆê°€. (ì„¸ë¡œ ì—…ë¡œë“œ ì‹œ ê°€ë¡œê°€ ì—†ìœ¼ë©´ ì°¨ë‹¨)
          </div>
        </div>

        <!-- Title Frame Uploads -->
        <div class="bg-gray-800 border border-gray-700 rounded-xl p-4 space-y-3">
          <div class="flex items-center justify-between">
            <div class="text-sm font-bold text-purple-300">íƒ€ì´í‹€ í”„ë ˆì„ ì—…ë¡œë“œ(íƒ€ì´í‹€ íƒ€ì…ì—ì„œ ì‚¬ìš©)</div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-gray-900 p-3 rounded border border-gray-700 flex gap-3 items-center">
              <div id="prevTLand" class="w-20 h-12 bg-black border border-gray-600 bg-cover bg-center rounded shrink-0"></div>
              <div class="flex-1">
                <div class="text-xs text-gray-300 font-bold">ğŸ’» íƒ€ì´í‹€ í”„ë ˆì„(ê°€ë¡œ)</div>
                <label class="file-input-wrapper w-full bg-gray-700 hover:bg-gray-600 text-center py-1.5 rounded border border-gray-600 text-xs mt-1">
                  ì—…ë¡œë“œ
                  <input type="file" accept="image/*" id="tLandFile">
                </label>
              </div>
            </div>

            <div class="bg-gray-900 p-3 rounded border border-gray-700 flex gap-3 items-center relative overflow-hidden">
              <div class="absolute top-0 right-0 bg-pink-600 text-[9px] px-1.5 py-0.5 rounded-bl font-bold">Shorts</div>
              <div id="prevTPort" class="w-8 h-12 bg-black border border-gray-600 bg-cover bg-center rounded shrink-0 flex items-center justify-center text-[8px] text-gray-500">PC</div>
              <div class="flex-1">
                <div class="text-xs text-gray-300 font-bold">ğŸ“± íƒ€ì´í‹€ í”„ë ˆì„(ì„¸ë¡œ)</div>
                <label class="file-input-wrapper w-full bg-gray-700 hover:bg-gray-600 text-center py-1.5 rounded border border-gray-600 text-xs mt-1">
                  ì—…ë¡œë“œ
                  <input type="file" accept="image/*" id="tPortFile">
                </label>
              </div>
            </div>
          </div>

          <div class="text-[10px] text-gray-400">
            * íƒ€ì´í‹€ í”„ë ˆì„ë„ ë™ì¼ ê·œì¹™: ì„¸ë¡œ í”„ë ˆì„ë§Œ ë‹¨ë… ë¶ˆê°€
          </div>
        </div>

        <!-- Script -->
        <div class="bg-gray-800 border border-gray-700 rounded-xl p-4 space-y-3">
          <div class="flex items-center justify-between">
            <div class="text-sm font-bold text-pink-300">ëŒ€ì‚¬</div>
            <button id="btnAddLine" class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-xs border border-gray-600">+ ì¶”ê°€</button>
          </div>
          <div id="scriptList" class="space-y-3"></div>
        </div>

        <!-- Choices -->
        <div class="bg-gray-800 border border-gray-700 rounded-xl p-4 space-y-3">
          <div class="flex items-center justify-between">
            <div class="text-sm font-bold text-green-300">ì„ íƒì§€</div>
            <button id="btnAddChoice" class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-xs border border-gray-600">+ ì¶”ê°€</button>
          </div>
          <div id="choiceList" class="space-y-2"></div>
          <div class="text-[10px] text-gray-500 text-center">ì„ íƒì§€ ì—†ìœ¼ë©´ ë‹¤ìŒ ì¥ë©´ìœ¼ë¡œ ìë™ ì§„í–‰</div>
        </div>

      </div>
    </section>

    <!-- Visual Maker Panel -->
    <section id="panelVisual" class="hidden h-full overflow-y-auto scroll-custom p-6">
      <div class="max-w-5xl mx-auto space-y-6 pb-24">
        <div class="text-xl font-bold">Visual Maker (í”„ë¡¬í”„íŠ¸ ìƒì„±ê¸°)</div>
        <div class="bg-gray-800 border border-gray-700 rounded-xl p-4 space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label class="text-xs text-gray-400">ì¥ì†Œ(í•„ìˆ˜)</label>
              <input id="vmPlace" class="w-full px-2 py-2 rounded border" placeholder="ì˜ˆ: í•™êµ ë³µë„, ë¹„ ì˜¤ëŠ” ê±°ë¦¬" />
            </div>
            <div>
              <label class="text-xs text-gray-400">ì‹œê°„/ë‚ ì”¨(ì„ íƒ)</label>
              <input id="vmTime" class="w-full px-2 py-2 rounded border" placeholder="ì˜ˆ: ë°¤, ë¹„, ë…¸ì„" />
            </div>
            <div class="md:col-span-2">
              <label class="text-xs text-gray-400">í‚¤ ì˜¤ë¸Œì íŠ¸(ì„ íƒ, ì‰¼í‘œ)</label>
              <input id="vmObj" class="w-full px-2 py-2 rounded border" placeholder="ì˜ˆ: ê°€ë¡œë“±, ì –ì€ ë³´ë„ë¸”ë¡, ë¹—ë¬¼ ì›…ë©ì´" />
            </div>
            <div>
              <label class="text-xs text-gray-400">ë¶„ìœ„ê¸°(ì„ íƒ)</label>
              <input id="vmMood" class="w-full px-2 py-2 rounded border" placeholder="ì˜ˆ: í‰ì˜¨, ê¸´ì¥, ë¡œë§¨í‹±" />
            </div>
            <div>
              <label class="text-xs text-gray-400">ìŠ¤íƒ€ì¼</label>
              <select id="vmStyle" class="w-full px-2 py-2 rounded border">
                <option value="anime_clean">ì• ë‹ˆ(í´ë¦°)</option>
                <option value="anime_pastel">ì• ë‹ˆ(íŒŒìŠ¤í…”)</option>
                <option value="semi_real">ì„¸ë¯¸ë¦¬ì–¼</option>
                <option value="toon_flat">íˆ°(í‰ë©´)</option>
                <option value="pixel_art">í”½ì…€ì•„íŠ¸</option>
              </select>
            </div>
          </div>

          <div class="border-t border-gray-700 pt-3 space-y-2">
            <div class="flex flex-wrap gap-4 items-center">
              <label class="flex items-center gap-2 text-sm">
                <input id="vmLand" type="checkbox" checked class="accent-pink-500"> ê°€ë¡œ(16:9)
              </label>
              <label class="flex items-center gap-2 text-sm">
                <input id="vmPort" type="checkbox" checked class="accent-pink-500"> ì„¸ë¡œ(9:16)
              </label>
              <label class="flex items-center gap-2 text-sm">
                <input id="vmTitleFrame" type="checkbox" class="accent-cyan-400"> íƒ€ì´í‹€ í”„ë ˆì„ ëª¨ë“œ
              </label>
            </div>

            <div id="vmTitleOpts" class="hidden bg-gray-900 border border-gray-700 rounded p-3 space-y-2">
              <div class="text-[10px] text-gray-400">
                íƒ€ì´í‹€ í”„ë ˆì„ì€ <b>í…ìŠ¤íŠ¸ ì—†ì´</b> ì¥ì‹ + ì•ˆì „ì˜ì—­ë§Œ í™•ë³´í•©ë‹ˆë‹¤. (í…ìŠ¤íŠ¸ëŠ” Game Makerê°€ ë Œë”ë§)
              </div>
              <div class="flex gap-4">
                <label class="flex items-center gap-2 text-sm">
                  <input type="radio" name="vmSafe" value="center" checked class="accent-cyan-400"> ì¤‘ì•™ ì•ˆì „ì˜ì—­
                </label>
                <label class="flex items-center gap-2 text-sm">
                  <input type="radio" name="vmSafe" value="top" class="accent-cyan-400"> ìƒë‹¨ ì•ˆì „ì˜ì—­
                </label>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <div>
                  <label class="text-xs text-gray-400">ì¥ì‹ íŒíŠ¸(ì„ íƒ)</label>
                  <input id="vmOrn" class="w-full px-2 py-2 rounded border" placeholder="ì˜ˆ: subtle glow frame, particles, filigree" />
                </div>
                <div>
                  <label class="text-xs text-gray-400">ì¥ì‹ ê°•ë„</label>
                  <select id="vmOrnInt" class="w-full px-2 py-2 rounded border">
                    <option value="subtle" selected>ì•½</option>
                    <option value="medium">ì¤‘</option>
                    <option value="strong">ê°•</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="flex gap-2">
              <button id="vmBuild" class="px-4 py-2 rounded bg-cyan-600 hover:bg-cyan-500 font-semibold">í”„ë¡¬í”„íŠ¸ ìƒì„±</button>
              <label class="ml-2 flex items-center gap-2 text-xs text-gray-300">
                <input id="vmMock" type="checkbox" class="accent-cyan-400">
                SVG ë¯¸ë¦¬ë³´ê¸°
              </label>
              <button id="vmSample" class="px-4 py-2 rounded bg-gray-700 hover:bg-gray-600">ìƒ˜í”Œ</button>
              <button id="vmCopy" class="ml-auto px-4 py-2 rounded bg-gray-700 hover:bg-gray-600">ì „ì²´ ë³µì‚¬</button>
            </div>
          </div>
        </div>

        <div class="bg-gray-800 border border-gray-700 rounded-xl p-4 space-y-3">
          <div class="text-sm font-bold">ì¶œë ¥</div>

          <div id="vmOutLandWrap" class="space-y-2">
            <div class="text-xs text-gray-300 font-bold">ê°€ë¡œ(16:9)</div>
            <pre id="vmOutLand" class="whitespace-pre-wrap text-xs leading-5 p-2 rounded bg-gray-900 border border-gray-700"></pre>
          </div>
          <img id="vmImgLand" class="hidden w-full rounded border border-gray-700" alt="land preview"/>


          <div id="vmOutPortWrap" class="space-y-2">
            <div class="text-xs text-gray-300 font-bold">ì„¸ë¡œ(9:16)</div>
            <pre id="vmOutPort" class="whitespace-pre-wrap text-xs leading-5 p-2 rounded bg-gray-900 border border-gray-700"></pre>
          </div>
          <img id="vmImgPort" class="hidden w-full rounded border border-gray-700" alt="port preview"/>


          <div class="space-y-2">
            <div class="text-xs text-gray-300 font-bold">Negative</div>
            <pre id="vmOutNeg" class="whitespace-pre-wrap text-xs leading-5 p-2 rounded bg-gray-900 border border-gray-700"></pre>
          </div>
        </div>
      </div>
    </section>

    <!-- Preview overlay -->
    <div id="previewOverlay" class="hidden fixed inset-0 bg-black z-50 flex flex-col items-center justify-center bg-opacity-95">
      <div class="absolute top-4 w-full flex justify-center items-center gap-4 z-50">
        <div class="bg-gray-800 rounded-full p-1 flex gap-1 border border-gray-600">
          <button id="btnLand" class="px-3 py-1 rounded-full text-xs font-bold bg-pink-600 text-white">PC</button>
          <button id="btnPort" class="px-3 py-1 rounded-full text-xs font-bold text-gray-300 hover:text-white">ëª¨ë°”ì¼</button>
        </div>
        <button id="btnReloadPrev" class="bg-gray-800 text-white w-8 h-8 rounded-full border border-gray-600 hover:bg-gray-700">â†»</button>
        <button id="btnClosePrev" class="bg-red-600 text-white w-8 h-8 rounded-full hover:bg-red-500">Ã—</button>
      </div>
      <div id="preview-frame-container" class="mode-landscape bg-black relative">
        <iframe id="gameFrame" class="w-full h-full border-none"></iframe>
      </div>
    </div>

  </main>

<script>
/* ===============================
   State
=============================== */
function makeDefaultProject(){
  return {
  name: "MyVN",
  settings: { font: "sans", titleStyle: "glow", gameTitle: "My Visual Novel" },
  scenes: [{
    id: 1,
    type: "normal", // normal | title
    // bg
    background: "",
    backgroundMobile: "",
    // title frame (optional)
    titleFrame: "",
    titleFrameMobile: "",
    titleText: "",
    subtitleText: "",
    safeAreaPos: "center", // center | top
    frameIntensity: "subtle",
    // content
    script: [{ speaker: "???", text: "ì•ˆë…•í•˜ì„¸ìš”. {{player}}", motion: "" }],
    choices: []
  }]
}
}

let project = makeDefaultProject();

let activeSceneId = 1;
let previewMode = "landscape"; // landscape | portrait
let previewUrl = null;

/* ===============================
   Helpers
=============================== */
const $ = (id) => document.getElementById(id);

function escapeHtml(s){
  return String(s??"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function escapeAttr(s){ return escapeHtml(s).replaceAll("\n"," "); }

function readFileAsDataURL(file){
  return new Promise(res=>{
    const r = new FileReader();
    r.onload = e => res(e.target.result);
    r.readAsDataURL(file);
  });
}

function autosave(){
  try{
    localStorage.setItem("vn_onefile_autosave_v1", JSON.stringify(project));
  }catch(e){}
}

function setStatus(msg){
  $("status").textContent = msg || "";
}


// Reindex scenes to ensure Scene 1 always exists and ids are sequential (1..N).
// Also rewrites choice nextSceneId references to keep links valid.
function reindexScenes(){
  const oldToNew = new Map();
  project.scenes.forEach((s, i) => oldToNew.set(Number(s.id), i + 1));

  project.scenes.forEach((s, i) => {
    const newId = i + 1;
    const oldId = Number(s.id);
    s.id = newId;

    // rewrite choice links
    if (Array.isArray(s.choices)) {
      s.choices.forEach(ch => {
        const tgt = Number(ch.nextSceneId);
        if (oldToNew.has(tgt)) ch.nextSceneId = oldToNew.get(tgt);
      });
    }
  });

  // update activeSceneId to new mapping, fallback to 1
  const mapped = oldToNew.get(Number(activeSceneId));
  activeSceneId = mapped ? mapped : 1;
}

// Start a fresh project (clears autosave too)
function newProject(){
  const ok = confirm("ìƒˆ í”„ë¡œì íŠ¸ë¥¼ ì‹œì‘í• ê¹Œìš”?\n(í˜„ì¬ ì‘ì—…ì€ ìë™ì €ì¥ í¬í•¨ ëª¨ë‘ ì´ˆê¸°í™”ë©ë‹ˆë‹¤)");
  if(!ok) return;

  project = makeDefaultProject();
  activeSceneId = 1;

  // keep current UI settings if you want (optional) - here we reset to defaults:
  syncTopSettingsToUI();
  cleanPortraitOnlyOnLoad();
  renderAll();
  autosave();
  setStatus("ìƒˆ í”„ë¡œì íŠ¸ ì‹œì‘");
}

/* ===============================
   Rules: portrait-only forbidden
   Apply to:
   - background/backgroundMobile
   - titleFrame/titleFrameMobile
=============================== */
function portraitOnlyViolations(){
  const badBg = [];
  const badTf = [];
  for(const s of project.scenes){
    if(s.backgroundMobile && !s.background) badBg.push(s.id);
    if(s.titleFrameMobile && !s.titleFrame) badTf.push(s.id);
  }
  return { badBg, badTf };
}

function validateNoPortraitOnly(action){
  const { badBg, badTf } = portraitOnlyViolations();
  if(badBg.length || badTf.length){
    let msg = `${action} ë¶ˆê°€:\n`;
    if(badBg.length) msg += `- ì„¸ë¡œ ë°°ê²½ë§Œ ìˆëŠ” ì¥ë©´: Scene ${badBg.join(", ")}\n`;
    if(badTf.length) msg += `- ì„¸ë¡œ íƒ€ì´í‹€í”„ë ˆì„ë§Œ ìˆëŠ” ì¥ë©´: Scene ${badTf.join(", ")}\n`;
    msg += `ê·œì¹™: ê°€ë¡œë§Œ ë˜ëŠ” ê°€ë¡œ+ì„¸ë¡œë§Œ í—ˆìš©ë©ë‹ˆë‹¤.`;
    alert(msg);
    return false;
  }
  return true;
}

function cleanPortraitOnlyOnLoad(){
  const { badBg, badTf } = portraitOnlyViolations();
  if(badBg.length){
    project.scenes.forEach(s=>{ if(s.backgroundMobile && !s.background) s.backgroundMobile=""; });
  }
  if(badTf.length){
    project.scenes.forEach(s=>{ if(s.titleFrameMobile && !s.titleFrame) s.titleFrameMobile=""; });
  }
  if(badBg.length || badTf.length){
    alert(`ê·œì¹™ ìœ„ë°˜ ìë™ì •ë¦¬:\n${badBg.length?("ë°°ê²½: "+badBg.join(", ")+"\n"):""}${badTf.length?("íƒ€ì´í‹€í”„ë ˆì„: "+badTf.join(", ")): ""}`);
  }
}

/* ===============================
   UI: Tabs
=============================== */
function setTab(tab){
  const isGame = tab==="game";
  $("panelGame").classList.toggle("hidden", !isGame);
  $("panelVisual").classList.toggle("hidden", isGame);

  $("tabGame").className = isGame
    ? "flex-1 py-2 rounded bg-pink-600 text-sm font-bold"
    : "flex-1 py-2 rounded bg-gray-700 hover:bg-gray-600 text-sm font-bold";
  $("tabVisual").className = !isGame
    ? "flex-1 py-2 rounded bg-pink-600 text-sm font-bold"
    : "flex-1 py-2 rounded bg-gray-700 hover:bg-gray-600 text-sm font-bold";
}

/* ===============================
   Scene Ops
=============================== */
function getActiveScene(){
  return project.scenes.find(s=>s.id===activeSceneId);
}

function addScene(){
  const id = project.scenes.length ? Math.max(...project.scenes.map(s=>s.id))+1 : 1;
  project.scenes.push({
    id,
    type: "normal",
    background: "", backgroundMobile: "",
    titleFrame: "", titleFrameMobile: "",
    titleText: "", subtitleText: "",
    safeAreaPos: "center",
    frameIntensity: "subtle",
    script: [{ speaker: "???", text: "...", motion: "", charImg: "" }],
    choices: []
  });
  activeSceneId = id;
  renderAll();
  autosave();
  setStatus("ìƒˆ ì¥ë©´ ì¶”ê°€");
}

function moveScene(index, dir){
  if(index+dir<0 || index+dir>=project.scenes.length) return;
  const t = project.scenes[index];
  project.scenes[index] = project.scenes[index+dir];
  project.scenes[index+dir] = t;
  renderSceneList();
  autosave();
}

function dupScene(index){
  const src = project.scenes[index];
  const id = Math.max(...project.scenes.map(s=>s.id))+1;
  const copy = JSON.parse(JSON.stringify(src));
  copy.id = id;
  project.scenes.splice(index+1,0,copy);
  activeSceneId = id;
  renderAll();
  autosave();
}

function delScene(index){
  if(project.scenes.length<=1) return alert("ìµœì†Œ 1ê°œ");
  if(!confirm("ì‚­ì œ?")) return;
  project.scenes.splice(index,1);
  // keep ids stable and ensure Scene 1 exists
  reindexScenes();
  renderAll();
  autosave();
}

/* ===============================
   Render: Scene list & Editor
=============================== */
function renderSceneList(){
  const root = $("sceneList");
  root.innerHTML = "";

  project.scenes.forEach((s, idx)=>{
    const isActive = s.id===activeSceneId;
    const row = document.createElement("div");
    row.className = `p-2 rounded border mb-2 flex flex-col gap-2 ${isActive ? "bg-pink-900/40 border-pink-500" : "bg-gray-800 border-gray-700 hover:bg-gray-700"}`;

    const header = document.createElement("div");
    header.className = "flex justify-between items-center cursor-pointer";
    header.onclick = ()=>{ activeSceneId=s.id; renderAll(); };

    const pv = escapeHtml(s.type==="title" ? (s.titleText||"(íƒ€ì´í‹€)") : (s.script?.[0]?.text||"..."));
    header.innerHTML = `
      <div class="flex items-center gap-2 overflow-hidden">
        <span class="text-xs font-bold ${isActive?"text-pink-300":"text-gray-400"} min-w-[70px]">Scene ${s.id}</span>
        <span class="text-[10px] text-gray-500 truncate">${pv}</span>
      </div>
      <span class="text-[10px] ${s.type==="title"?"text-purple-300":"text-gray-500"}">${s.type==="title"?"TITLE":"NORMAL"}</span>
    `;

    const controls = document.createElement("div");
    controls.className = "flex justify-end gap-1 border-t border-gray-700/50 pt-1";
    const btn = "px-2 py-0.5 rounded text-[9px] bg-gray-700 hover:bg-gray-600 text-gray-300 border border-gray-600";
    if(idx>0) controls.innerHTML += `<button class="${btn}" data-act="up">â†‘</button>`;
    if(idx<project.scenes.length-1) controls.innerHTML += `<button class="${btn}" data-act="down">â†“</button>`;
    controls.innerHTML += `<button class="${btn} text-blue-300" data-act="dup">ë³µ</button>`;
    if(project.scenes.length>1) controls.innerHTML += `<button class="${btn} text-red-300" data-act="del">ì‚­ì œ</button>`;

    controls.addEventListener("click",(e)=>{
      e.stopPropagation();
      const act = e.target.closest("button")?.dataset?.act;
      if(!act) return;
      if(act==="up") moveScene(idx,-1);
      if(act==="down") moveScene(idx,1);
      if(act==="dup") dupScene(idx);
      if(act==="del") delScene(idx);
    });

    row.appendChild(header);
    row.appendChild(controls);
    root.appendChild(row);
  });
}

function renderEditor(){
  const s = getActiveScene();
  if(!s) return;

  $("activeSceneBadge").textContent = `Scene ${s.id}`;
  $("activeSceneBadge").className = `bg-pink-600 px-2 py-1 rounded text-xs`;

  // type
  $("sceneType").value = s.type || "normal";
  $("titleText").value = s.titleText || "";
  $("subtitleText").value = s.subtitleText || "";
  $("safeAreaPos").value = s.safeAreaPos || "center";
  $("frameIntensity").value = s.frameIntensity || "subtle";

  // previews
  $("prevLand").style.backgroundImage = s.background ? `url('${s.background}')` : "none";
  const portPrev = $("prevPort");
  portPrev.style.backgroundImage = s.backgroundMobile ? `url('${s.backgroundMobile}')` : (s.background ? `url('${s.background}')` : "none");
  portPrev.textContent = s.backgroundMobile ? "" : (s.background ? "PC" : "");

  $("prevTLand").style.backgroundImage = s.titleFrame ? `url('${s.titleFrame}')` : "none";
  const tPortPrev = $("prevTPort");
  tPortPrev.style.backgroundImage = s.titleFrameMobile ? `url('${s.titleFrameMobile}')` : (s.titleFrame ? `url('${s.titleFrame}')` : "none");
  tPortPrev.textContent = s.titleFrameMobile ? "" : (s.titleFrame ? "PC" : "");

  // script list
  const scriptRoot = $("scriptList");
  scriptRoot.innerHTML = "";
  (s.script||[]).forEach((line,i)=>{
    const div = document.createElement("div");
    div.className = "flex gap-2 items-start bg-gray-800/40 p-2 rounded border border-gray-700";
    div.innerHTML = `
      <div class="flex flex-col gap-2 w-1/4 min-w-[110px]">
        <input class="w-full rounded border px-2 py-1 text-xs text-yellow-300 font-bold"
               placeholder="í™”ì" value="${escapeAttr(line.speaker)}">
        <select class="rounded border px-2 py-1 text-[10px]">
          <option value="" ${line.motion===''?'selected':''}>ëª¨ì…˜ ì—†ìŒ</option>
          <option value="jump" ${line.motion==='jump'?'selected':''}>jump</option>
          <option value="shake" ${line.motion==='shake'?'selected':''}>shake</option>
          <option value="zoom" ${line.motion==='zoom'?'selected':''}>zoom</option>
        </select>
<label class="file-input-wrapper w-full bg-gray-700 hover:bg-gray-600 text-center py-1 rounded border border-gray-600 text-[10px] text-gray-200">
  <span>ìºë¦­í„° ì´ë¯¸ì§€</span>
  <input type="file" accept="image/*" data-char-upload="1">
</label>
<div class="text-[10px] text-gray-500 truncate" data-char-status="1">ì—†ìŒ</div>

      </div>
      <div class="flex-1 relative">
        <textarea class="w-full rounded border px-2 py-1 text-sm resize-none h-24 leading-relaxed" placeholder="ëŒ€ì‚¬"></textarea>
        ${(s.script.length>1)?`<button class="absolute top-1 right-1 w-6 h-6 bg-gray-700 text-gray-300 hover:bg-red-900/50 hover:text-red-300 rounded" data-del="${i}">âˆ’</button>`:""}
      </div>
    `;
    const speakerInput = div.querySelector("input");
    const motionSel = div.querySelector("select");
    const ta = div.querySelector("textarea");
    ta.value = String(line.text??"");
const up = div.querySelector('input[type="file"][data-char-upload="1"]');
const st = div.querySelector('[data-char-status="1"]');

st.textContent = line.charImg ? "ì„¤ì •ë¨" : "ì—†ìŒ";

up.addEventListener("change", async (e) => {
  const f = e.target.files[0];
  if (!f) return;
  line.charImg = await readFileAsDataURL(f);
  st.textContent = "ì„¤ì •ë¨";
  autosave();
  e.target.value = "";
});

    speakerInput.addEventListener("input", ()=>{ line.speaker = speakerInput.value; autosave(); });
    motionSel.addEventListener("change", ()=>{ line.motion = motionSel.value; autosave(); });
    ta.addEventListener("input", ()=>{ line.text = ta.value; autosave(); });

    div.addEventListener("click",(e)=>{
      const delIdx = e.target.closest("button")?.dataset?.del;
      if(delIdx!==undefined){
        s.script.splice(Number(delIdx),1);
        renderEditor();
        autosave();
      }
    });

    scriptRoot.appendChild(div);
  });

  // choices
  const choiceRoot = $("choiceList");
  choiceRoot.innerHTML = "";
  (s.choices||[]).forEach((c,i)=>{
    const exists = project.scenes.some(x=>x.id===Number(c.nextSceneId));
    const div = document.createElement("div");
    div.className = "flex gap-2 items-center bg-gray-900 p-2 rounded border border-gray-700";
    div.innerHTML = `
      <input class="flex-1 rounded border px-2 py-1 text-xs" value="${escapeAttr(c.text)}" placeholder="ì„ íƒì§€ í…ìŠ¤íŠ¸">
      <input type="number" class="w-16 rounded border px-2 py-1 text-xs text-center ${exists?'border-gray-600':'border-red-500'}" value="${Number(c.nextSceneId)||0}">
      <button class="px-2 text-gray-400 hover:text-red-400" data-del="${i}">Ã—</button>
    `;
    const inpText = div.querySelectorAll("input")[0];
    const inpNext = div.querySelectorAll("input")[1];
    inpText.addEventListener("input", ()=>{ c.text = inpText.value; autosave(); });
    inpNext.addEventListener("input", ()=>{ c.nextSceneId = parseInt(inpNext.value)||0; autosave(); renderEditor(); });
    div.querySelector("button").addEventListener("click", ()=>{
      s.choices.splice(i,1);
      renderEditor();
      autosave();
    });
    choiceRoot.appendChild(div);
  });

  // disable script/choices if title type? (still editable but preview will ignore)
  const isTitle = s.type==="title";
  $("btnAddLine").disabled = isTitle;
  $("btnAddChoice").disabled = isTitle;
  $("btnAddLine").classList.toggle("opacity-50", isTitle);
  $("btnAddChoice").classList.toggle("opacity-50", isTitle);
}

/* ===============================
   Game Maker: Input wiring
=============================== */
function wireGameInputs(){
  // scene type
  $("sceneType").addEventListener("change", ()=>{
    const s = getActiveScene();
    s.type = $("sceneType").value;
    autosave();
    renderSceneList();
  });

  $("titleText").addEventListener("input", ()=>{
    const s = getActiveScene();
    s.titleText = $("titleText").value;
    autosave();
    renderSceneList();
  });

  $("subtitleText").addEventListener("input", ()=>{
    const s = getActiveScene();
    s.subtitleText = $("subtitleText").value;
    autosave();
  });

  $("safeAreaPos").addEventListener("change", ()=>{
    const s = getActiveScene();
    s.safeAreaPos = $("safeAreaPos").value;
    autosave();
  });

  $("frameIntensity").addEventListener("change", ()=>{
    const s = getActiveScene();
    s.frameIntensity = $("frameIntensity").value;
    autosave();
  });

  // bg uploads
  $("bgLandFile").addEventListener("change", async (e)=>{
    const s = getActiveScene();
    const f = e.target.files[0];
    if(!f) return;
    s.background = await readFileAsDataURL(f);
    renderEditor();
    autosave();
  });

  $("bgPortFile").addEventListener("change", async (e)=>{
    const s = getActiveScene();
    const f = e.target.files[0];
    if(!f) return;
    // rule: portrait-only forbidden
    if(!s.background){
      alert("ì„¸ë¡œ ë°°ê²½ë§Œ ë‹¨ë…ì€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.\në¨¼ì € ê°€ë¡œ ë°°ê²½ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.");
      e.target.value="";
      return;
    }
    s.backgroundMobile = await readFileAsDataURL(f);
    renderEditor();
    autosave();
  });

  // title frame uploads
  $("tLandFile").addEventListener("change", async (e)=>{
    const s = getActiveScene();
    const f = e.target.files[0];
    if(!f) return;
    s.titleFrame = await readFileAsDataURL(f);
    renderEditor();
    autosave();
  });

  $("tPortFile").addEventListener("change", async (e)=>{
    const s = getActiveScene();
    const f = e.target.files[0];
    if(!f) return;
    // rule
    if(!s.titleFrame){
      alert("ì„¸ë¡œ íƒ€ì´í‹€í”„ë ˆì„ë§Œ ë‹¨ë…ì€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.\në¨¼ì € ê°€ë¡œ íƒ€ì´í‹€í”„ë ˆì„ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.");
      e.target.value="";
      return;
    }
    s.titleFrameMobile = await readFileAsDataURL(f);
    renderEditor();
    autosave();
  });

  // add line/choice
  $("btnAddLine").addEventListener("click", ()=>{
    const s = getActiveScene();
    if(s.type==="title") return;
    const last = s.script[s.script.length-1];
s.script.push({ speaker: last?last.speaker:"???", text:"", motion:"", charImg:"" });

    renderEditor();
    autosave();
  });

  $("btnAddChoice").addEventListener("click", ()=>{
    const s = getActiveScene();
    if(s.type==="title") return;
    s.choices = s.choices || [];
    const next = getNextSceneId(s.id) ?? 0;
    s.choices.push({ text: "ì„ íƒì§€", nextSceneId: next });
    renderEditor();
    autosave();
  });
}

function getNextSceneId(id){
  const ids = project.scenes.map(s=>s.id);
  const i = ids.indexOf(id);
  return (i>=0 && i<ids.length-1) ? ids[i+1] : null;
}

/* ===============================
   Save/Load/Export
=============================== */
function downloadBlob(blob, filename){
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
}

function saveProject(){
  if(!validateNoPortraitOnly("ì €ì¥")) return;
  project.name = $("projectName").value || "MyVN";
  project.settings.gameTitle = $("gameTitle").value || "My Visual Novel";
  const blob = new Blob([JSON.stringify(project,null,2)], {type:"application/json"});
  downloadBlob(blob, `${project.name}.json`);
  setStatus("í”„ë¡œì íŠ¸ ì €ì¥");
}

function loadProjectFromText(text){
  const p = JSON.parse(text);
  if(!p || !Array.isArray(p.scenes) || !p.scenes.length) throw new Error("í”„ë¡œì íŠ¸ êµ¬ì¡° ì˜¤ë¥˜");
  project = p;
  if(!project.settings) project.settings = { font:"sans", titleStyle:"glow", gameTitle:"My Visual Novel" };

  // block neon if someone put it
  if(String(project.settings.titleStyle||"").toLowerCase()==="neon") project.settings.titleStyle = "glow";

  activeSceneId = project.scenes[0].id;
  cleanPortraitOnlyOnLoad();
  reindexScenes();
  syncTopSettingsToUI();
  renderAll();
  autosave();
  setStatus("í”„ë¡œì íŠ¸ ë¡œë“œ");
}

function exportDataJson(){
  if(!validateNoPortraitOnly("ë‚´ë³´ë‚´ê¸°")) return;
  const data = {
    meta: {
      gameTitle: $("gameTitle").value || "My Visual Novel",
      font: $("fontSel").value || "sans",
      titleStyle: $("titleStyleSel").value || "glow"
    },
    scenes: project.scenes
  };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  downloadBlob(blob, "data.json");
  setStatus("data.json ë‚´ë³´ë‚´ê¸°");
}

function syncTopSettingsToUI(){
  $("projectName").value = project.name || "MyVN";
  $("gameTitle").value = project.settings?.gameTitle || "My Visual Novel";
  $("fontSel").value = project.settings?.font || "sans";
  $("titleStyleSel").value = project.settings?.titleStyle || "glow";
}

function bindTopSettings(){
  $("projectName").addEventListener("input", ()=>{
    project.name = $("projectName").value;
    autosave();
  });
  $("gameTitle").addEventListener("input", ()=>{
    if(!project.settings) project.settings = {};
    project.settings.gameTitle = $("gameTitle").value;
    autosave();
  });
  $("fontSel").addEventListener("change", ()=>{
    if(!project.settings) project.settings = {};
    project.settings.font = $("fontSel").value;
    autosave();
  });
  $("titleStyleSel").addEventListener("change", ()=>{
    const v = String($("titleStyleSel").value||"").toLowerCase();
    if(v==="neon"){
      alert("ë„¤ì˜¨ì€ ì œì™¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
      $("titleStyleSel").value = "glow";
      return;
    }
    if(!project.settings) project.settings = {};
    project.settings.titleStyle = v;
    autosave();
  });
}

/* ===============================
   Preview
=============================== */
function openPreview(){
  if(!validateNoPortraitOnly("ë¯¸ë¦¬ë³´ê¸°")) return;
  $("previewOverlay").classList.remove("hidden");
  reloadPreview();
}

function closePreview(){
  $("previewOverlay").classList.add("hidden");
  $("gameFrame").src = "";
  if(previewUrl){ URL.revokeObjectURL(previewUrl); previewUrl=null; }
}

function setPreviewMode(mode){
  previewMode = mode;
  const c = $("preview-frame-container");
  if(mode==="landscape"){
    c.className="mode-landscape bg-black relative";
    $("btnLand").className="px-3 py-1 rounded-full text-xs font-bold bg-pink-600 text-white";
    $("btnPort").className="px-3 py-1 rounded-full text-xs font-bold text-gray-300 hover:text-white";
  }else{
    c.className="mode-portrait bg-black relative";
    $("btnLand").className="px-3 py-1 rounded-full text-xs font-bold text-gray-300 hover:text-white";
    $("btnPort").className="px-3 py-1 rounded-full text-xs font-bold bg-pink-600 text-white";
  }
  reloadPreview();
}

function reloadPreview(){
  if(!validateNoPortraitOnly("ë¯¸ë¦¬ë³´ê¸°")) return;

  const data = {
    meta: {
      gameTitle: $("gameTitle").value || "My Visual Novel",
      font: $("fontSel").value || "sans",
      titleStyle: $("titleStyleSel").value || "glow"
    },
    scenes: JSON.parse(JSON.stringify(project.scenes))
  };

  const html = buildRuntimeHTML(data, previewMode);
  const blob = new Blob([html], {type:"text/html"});
  if(previewUrl) URL.revokeObjectURL(previewUrl);
  previewUrl = URL.createObjectURL(blob);
  $("gameFrame").src = previewUrl;
}

function buildRuntimeHTML(DATA, forcedMode){
  const safeData = JSON.stringify(DATA);

  return `<!doctype html><html lang="ko"><head><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<title>VN Preview</title>
<style>
  body{margin:0;background:#000;overflow:hidden;user-select:none}
  #game{position:relative;width:100vw;height:100vh;background:#000;overflow:hidden}
  #bg{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;object-position:50% 50%;transform:scale(1.001);pointer-events:none;z-index:0}
    #char{
      position:absolute;
      left:50%;
      bottom:0;
      transform:translateX(-50%);
      height:90vh;
      max-width:100%;
      object-fit:contain;
      z-index:15;
      pointer-events:none;
      transition:.15s ease;
    }
    @media (orientation:portrait){
      #char{height:75vh; bottom:10vh;}
    }
    .anim-jump{ animation: jump .4s ease; }
    .anim-shake{ animation: shake .4s ease; }
    .anim-zoom{ transform: translateX(-50%) scale(1.12) !important; }
    @keyframes jump{
      0%,100%{ transform:translateX(-50%) translateY(0); }
      50%{ transform:translateX(-50%) translateY(-30px); }
    }
    @keyframes shake{
      0%,100%{ transform:translateX(-50%); }
      25%{ transform:translateX(-55%); }
      75%{ transform:translateX(-45%); }
    }
  .hidden{display:none!important}

  /* title / name */
  #title-screen,#name-input{position:absolute;inset:0;z-index:50;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;text-align:center;background:#111;padding:8vh 6vw}
  #title-screen h1{font-size:3rem;margin:0 0 22px;letter-spacing:.08em}
  #title-screen p{margin:0 0 18px;opacity:.7;font-size:12px;white-space:pre-wrap;max-width:520px;line-height:1.5}
  .btn{padding:14px 38px;font-size:1.1rem;margin:8px;border-radius:30px;border:none;cursor:pointer;font-weight:800;width:220px;font-family:inherit}
  .btn-start{background:linear-gradient(45deg,#ec4899,#f43f5e);color:#fff}
  .btn-load{background:transparent;border:2px solid #fff;color:#fff}
  input[type=text]{padding:14px;font-size:1.2rem;text-align:center;border-radius:14px;border:2px solid #555;background:#222;color:#fff;margin-bottom:16px;width:80%;max-width:320px;font-family:inherit}

  /* chapter layer */
  #chapter{position:absolute;inset:0;z-index:40;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:8vh 6vw}
  #chapter.top{justify-content:flex-start;padding-top:10vh}
  #chTitle{font-size:clamp(28px,6vw,72px);font-weight:900;letter-spacing:.08em}
  #chSub{margin-top:12px;font-size:clamp(14px,2.2vw,24px);opacity:.9;letter-spacing:.12em}
  #chHint{margin-top:24px;font-size:12px;opacity:.55}

  /* dialogue ui */
  #ui{position:absolute;left:0;right:0;bottom:0;z-index:20;padding:18px;box-sizing:border-box;background:linear-gradient(to top,rgba(0,0,0,.9),transparent);min-height:25vh;display:flex;flex-direction:column;justify-content:flex-end}
  #name{color:#fbbf24;font-size:1.25rem;font-weight:900;margin-bottom:8px;text-shadow:1px 1px 2px #000}
  #text{background:rgba(0,0,0,.7);border:1px solid rgba(255,255,255,.18);border-radius:15px;padding:18px;color:#fff;font-size:1.1rem;line-height:1.6;min-height:96px;white-space:pre-wrap}

  #choices{position:absolute;inset:0;z-index:45;background:rgba(0,0,0,.82);display:none;flex-direction:column;align-items:center;justify-content:center;gap:12px;padding:20px}
  .choice{width:100%;max-width:420px;padding:18px;font-size:1.05rem;border-radius:15px;border:none;background:#fff;color:#000;font-weight:900;cursor:pointer}
  .choice:active{transform:scale(.98);background:#fbbf24}

  /* title styles (NO neon) */
  .ts-minimal #chTitle{ text-shadow:none; opacity:.95; }
  .ts-glow #chTitle{ text-shadow:0 0 14px rgba(255,255,255,.35), 0 0 36px rgba(236,72,153,.35); }
  .ts-paper #chTitle{ text-shadow:2px 2px 0 rgba(0,0,0,.8); filter:contrast(1.1); }
  .ts-romantic #chTitle{ text-shadow:0 0 18px rgba(244,114,182,.45), 0 0 42px rgba(251,113,133,.25); }
  .ts-sleek #chTitle{ letter-spacing:.18em; text-shadow:0 0 10px rgba(255,255,255,.18); }
  .ts-classic #chTitle{ letter-spacing:.06em; text-shadow:1px 2px 0 rgba(0,0,0,.75), 0 0 18px rgba(255,255,255,.18); }
  .ts-sparkle #chTitle{ text-shadow:0 0 10px rgba(255,255,255,.25), 0 0 28px rgba(236,72,153,.25); }
  .ts-outline #chTitle{ text-shadow: 2px 2px 0 rgba(0,0,0,.85), -2px 2px 0 rgba(0,0,0,.85), 2px -2px 0 rgba(0,0,0,.85), -2px -2px 0 rgba(0,0,0,.85); }
  /* NEW: gold */
  .ts-gold #chTitle{
    background: linear-gradient(180deg, #fff6cc 0%, #ffd26a 22%, #f7b733 48%, #ffd26a 72%, #fff2b0 100%);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    text-shadow:
      0 2px 0 rgba(0,0,0,.55),
      0 0 22px rgba(255,210,106,.22),
      0 0 46px rgba(247,183,51,.14);
    letter-spacing: .10em;
  }

  /* NEW: glass */
  .ts-glass #chTitle{
    color: rgba(255,255,255,.88);
    text-shadow:
      0 2px 0 rgba(0,0,0,.55),
      0 0 26px rgba(255,255,255,.16);
    position: relative;
  }
  .ts-glass #chTitle::after{
    content: "";
    position: absolute;
    left: -6%;
    top: 10%;
    width: 112%;
    height: 60%;
    pointer-events: none;
    background: linear-gradient(135deg, rgba(255,255,255,.22), rgba(255,255,255,0));
    transform: skewX(-18deg);
    filter: blur(0.2px);
    opacity: .75;
  }

  /* NEW: luxury (ê³ ê¸‰, ì€ì€í•œ ê³ ê¸‰ê°) */
  .ts-luxury #chTitle{
    color: rgba(255,255,255,.94);
    letter-spacing: .16em;
    text-shadow:
      0 2px 0 rgba(0,0,0,.60),
      0 0 18px rgba(255,255,255,.12),
      0 0 40px rgba(236,72,153,.10);
  }
  .ts-luxury #chTitle{
    text-decoration: underline;
    text-decoration-thickness: 2px;
    text-underline-offset: 10px;
    text-decoration-color: rgba(255,255,255,.22);
  }

  /* NEW: subtle (ì€ì€) */
  .ts-subtle #chTitle{
    color: rgba(255,255,255,.92);
    letter-spacing: .08em;
    text-shadow:
      0 1px 0 rgba(0,0,0,.55),
      0 0 10px rgba(255,255,255,.10);
    opacity: .95;
  }

  
  /* Mirror title styles for the initial title screen (Scene1 title + Start/Continue) */
  .ts-minimal #title-screen h1{ text-shadow:none; opacity:.95; }
  .ts-glow #title-screen h1{ text-shadow:0 0 14px rgba(255,255,255,.35), 0 0 36px rgba(236,72,153,.35); }
  .ts-paper #title-screen h1{ text-shadow:2px 2px 0 rgba(0,0,0,.8); filter:contrast(1.1); }
  .ts-romantic #title-screen h1{ text-shadow:0 0 18px rgba(244,114,182,.45), 0 0 42px rgba(251,113,133,.25); }
  .ts-sleek #title-screen h1{ letter-spacing:.18em; text-shadow:0 0 10px rgba(255,255,255,.18); }
  .ts-classic #title-screen h1{ letter-spacing:.06em; text-shadow:1px 2px 0 rgba(0,0,0,.75), 0 0 18px rgba(255,255,255,.18); }
  .ts-sparkle #title-screen h1{ text-shadow:0 0 10px rgba(255,255,255,.25), 0 0 28px rgba(236,72,153,.25); }
  .ts-outline #title-screen h1{ text-shadow: 2px 2px 0 rgba(0,0,0,.85), -2px 2px 0 rgba(0,0,0,.85), 2px -2px 0 rgba(0,0,0,.85), -2px -2px 0 rgba(0,0,0,.85); }

  .ts-gold #title-screen h1{
    background: linear-gradient(180deg, #fff6cc 0%, #ffd26a 22%, #f7b733 48%, #ffd26a 72%, #fff2b0 100%);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    text-shadow: 0 2px 0 rgba(0,0,0,.55), 0 0 22px rgba(255,210,106,.22), 0 0 46px rgba(247,183,51,.14);
    letter-spacing: .10em;
  }

  .ts-glass #title-screen h1{
    color: rgba(255,255,255,.88);
    text-shadow: 0 2px 0 rgba(0,0,0,.55), 0 0 26px rgba(255,255,255,.16);
    position: relative;
  }
  .ts-glass #title-screen h1::after{
    content: "";
    position: absolute;
    left: -6%;
    top: 10%;
    width: 112%;
    height: 60%;
    pointer-events: none;
    background: linear-gradient(135deg, rgba(255,255,255,.22), rgba(255,255,255,0));
    transform: skewX(-18deg);
    filter: blur(0.2px);
    opacity: .75;
  }

  .ts-luxury #title-screen h1{
    color: rgba(255,255,255,.94);
    letter-spacing: .16em;
    text-shadow: 0 2px 0 rgba(0,0,0,.60), 0 0 18px rgba(255,255,255,.12), 0 0 40px rgba(236,72,153,.10);
    text-decoration: underline;
    text-decoration-thickness: 2px;
    text-underline-offset: 10px;
    text-decoration-color: rgba(255,255,255,.22);
  }

  .ts-subtle #title-screen h1{
    color: rgba(255,255,255,.92);
    letter-spacing: .08em;
    text-shadow: 0 1px 0 rgba(0,0,0,.55), 0 0 10px rgba(255,255,255,.10);
    opacity: .95;
  }

@media (orientation:portrait){
    #title-screen h1{font-size:2.4rem}
    #ui{min-height:30vh;padding:14px}
    #text{font-size:1.02rem;padding:14px}
    #name{font-size:1.12rem}
  }
</style></head><body>
<div id="game" onclick="next()">
  <img id="bg"/>
<img id="char" class="hidden" />
  <div id="title-screen">
    <h1 id="gameTitle"></h1>
    <p id="titleSub" style="margin:0 0 14px;opacity:.75;font-size:14px;letter-spacing:.08em;white-space:pre-wrap"></p>
    <p id="fatal" class="hidden" style="color:#fca5a5"></p>
    <button class="btn btn-start" onclick="showName(event)">Start</button>
    <button id="btnCont" class="btn btn-load" onclick="loadSave(event)" style="display:none">Continue</button>
  </div>
  <div id="name-input" class="hidden">
    <h2 style="margin:0 0 14px">ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”</h2>
    <input type="text" id="pn" placeholder="ì´ë¦„" maxlength="8">
    <button class="btn btn-start" onclick="start(event)">OK</button>
  </div>

  <div id="chapter" class="hidden">
    <div id="chTitle"></div>
    <div id="chSub"></div>
    <div id="chHint">Tap to continue</div>
  </div>

  <div id="choices"></div>
  <div id="ui" class="hidden"><div id="name"></div><div id="text"></div></div>
</div>

<script>
  const DATA = ${safeData};
  const meta = DATA.meta || {};
  const scenes = Array.isArray(DATA.scenes) ? DATA.scenes : [];
  let cur=null, idx=0, pn="Player", ty=false, tm=null, ft="", isPort=false;
  const KEY="VN_ONEFILE_SAVE";

    function getStartSceneId(){
      // Scene 1ì´ titleì´ë©´: OK í›„ Scene 2ë¡œ ì§„ì…(ì—†ìœ¼ë©´ Scene1)
      if(scenes[0] && scenes[0].type==="title"){
        return (scenes[1] && scenes[1].id) ? scenes[1].id : scenes[0].id;
      }
      return (scenes[0] && scenes[0].id) ? scenes[0].id : 1;
    }


  function fontFamily(font){
    if(font==="serif") return "'Batang', serif";
    if(font==="cursive") return "'Gaegu', cursive";
    return "'Apple SD Gothic Neo','Malgun Gothic',sans-serif";
  }
  document.body.style.fontFamily = fontFamily(String(meta.font||"sans"));

  function validate(){
    const badBg = scenes.filter(s=>s.backgroundMobile && !s.background).map(s=>s.id);
    const badTf = scenes.filter(s=>s.titleFrameMobile && !s.titleFrame).map(s=>s.id);
    if(badBg.length || badTf.length){
      const f=document.getElementById("fatal");
      let msg="ì‹¤í–‰ ë¶ˆê°€: ì„¸ë¡œë§Œ ë‹¨ë…ì¸ í•­ëª©ì´ ìˆìŠµë‹ˆë‹¤.\\n";
      if(badBg.length) msg += "- ë°°ê²½: Scene " + badBg.join(", ") + "\\n";
      if(badTf.length) msg += "- íƒ€ì´í‹€í”„ë ˆì„: Scene " + badTf.join(", ") + "\\n";
      f.textContent=msg;
      f.classList.remove("hidden");
      document.querySelectorAll(".btn").forEach(b=>b.disabled=true);
      return false;
    }
    return true;
  }

  function applyTitleStyle(){
    const st = String(meta.titleStyle||"glow").toLowerCase();
    const cls = "ts-" + (st==="neon" ? "glow" : st);

    const ch = document.getElementById("chapter");
    if(ch){
      ch.className = ch.className.replace(/\\bts-\\w+\\b/g,"").trim();
      ch.classList.add(cls);
    }

    const ts = document.getElementById("title-screen");
    if(ts){
      ts.className = ts.className.replace(/\\bts-\\w+\\b/g,"").trim();
      ts.classList.add(cls);
    }
  }

  function checkOrient(){
    const forced = "${forcedMode}";
    if(forced==="portrait") isPort=true;
    else if(forced==="landscape") isPort=false;
    else isPort = window.innerHeight > window.innerWidth;
    if(cur) setBg();
  }
  window.addEventListener("resize", checkOrient);

  function pickSrc(land, port){
    return isPort ? (port || land) : (land || port);
  }

  function setBg(){
    if(!cur) return;
    const isTitle = cur.type==="title";
    const src = isTitle
      ? pickSrc(cur.titleFrame, cur.titleFrameMobile) || pickSrc(cur.background, cur.backgroundMobile)
      : pickSrc(cur.background, cur.backgroundMobile);
    document.getElementById("bg").src = src || "";
  }

  function showName(e){
    e.stopPropagation();
    document.getElementById("title-screen").classList.add("hidden");
    document.getElementById("name-input").classList.remove("hidden");
  }
  function start(e){
    e.stopPropagation();
    pn = document.getElementById("pn").value.trim() || "Player";
    document.getElementById("name-input").classList.add("hidden");
    document.getElementById("ui").classList.remove("hidden");
    loadScene(getStartSceneId());
  }

  function checkSave(){
    if(localStorage.getItem(KEY)) document.getElementById("btnCont").style.display="block";
  }
  function loadSave(e){
    e.stopPropagation();
    const raw = localStorage.getItem(KEY);
    if(!raw) return;
    const s = JSON.parse(raw);
    pn = s.name || pn;
    document.getElementById("title-screen").classList.add("hidden");
    document.getElementById("ui").classList.remove("hidden");
    loadScene(s.sid, s.lidx);
  }

  function loadScene(id, l=0){
    cur = scenes.find(s=>s.id===id);
    if(!cur) return alert("End");
    setBg();

    // title scene
    if(cur.type==="title"){
      document.getElementById("ui").classList.add("hidden");
      document.getElementById("choices").style.display="none";

      const ch = document.getElementById("chapter");
      ch.classList.remove("hidden");
      ch.classList.toggle("top", (cur.safeAreaPos||"center")==="top");
      document.getElementById("chTitle").textContent = cur.titleText || "";
      document.getElementById("chSub").textContent = cur.subtitleText || "";
      idx = 0;
      localStorage.setItem(KEY, JSON.stringify({sid:cur.id, lidx:0, name:pn}));
      return;
    }

    document.getElementById("chapter").classList.add("hidden");
    document.getElementById("ui").classList.remove("hidden");

    idx = l;
    playLine();
  }

  function playLine(){
    localStorage.setItem(KEY, JSON.stringify({sid:cur.id, lidx:idx, name:pn}));
    const l = (cur.script||[])[idx] || {speaker:"",text:""};
    // ìºë¦­í„° ì´ë¯¸ì§€ í‘œì‹œ
    const chImg = document.getElementById("char");
    chImg.className = "hidden";
    if(l.charImg){
      chImg.src = l.charImg;
      chImg.classList.remove("hidden");
      if(l.motion){
        chImg.classList.add("anim-" + l.motion);
        void chImg.offsetWidth;
      }
    }
    document.getElementById("name").innerText = String(l.speaker||"").replace("{{player}}", pn);
    ft = String(l.text||"").replace("{{player}}", pn);

    const tb = document.getElementById("text");
    tb.textContent = "";
    ty = true;
    let i=0;
    if(tm) clearInterval(tm);
    tm = setInterval(()=>{
      tb.textContent += ft.charAt(i++);
      if(i>=ft.length){ clearInterval(tm); ty=false; }
    }, 28);
  }

  function loadNext(){
    const ci = scenes.findIndex(s=>cur && s && s.id===cur.id);
    const next = (ci>=0) ? scenes[ci+1] : null;
    if(next) loadScene(next.id);
    else alert("End");
  }

  function next(){
    if(!validate()) return;

    if(!document.getElementById("title-screen").classList.contains("hidden")) return;
    if(!document.getElementById("name-input").classList.contains("hidden")) return;
    if(document.getElementById("choices").style.display==="flex") return;

    if(cur && cur.type==="title"){
      document.getElementById("chapter").classList.add("hidden");
      loadNext();
      return;
    }

    const tb = document.getElementById("text");
    if(ty){ clearInterval(tm); tb.textContent = ft; ty=false; return; }

    if(idx < (cur.script||[]).length - 1){
      idx++; playLine();
    } else {
      if(cur.choices && cur.choices.length){
        const b = document.getElementById("choices");
        b.innerHTML = "";
        b.style.display = "flex";
        cur.choices.forEach(ch=>{
          const btn = document.createElement("button");
          btn.className = "choice";
          btn.innerText = String(ch.text||"").replace("{{player}}", pn);
          btn.onclick = (e)=>{
            e.stopPropagation();
            b.style.display="none";
            loadScene(Number(ch.nextSceneId)||0);
          };
          b.appendChild(btn);
        });
      } else loadNext();
    }
  }

  (function init(){
    const first = scenes[0];
    // Scene 1ì´ titleì´ë©´: íƒ€ì´í‹€ í™”ë©´ì„ Scene1 ê¸°ë°˜ìœ¼ë¡œ í‘œì‹œ(í”„ë ˆì„ ë°°ê²½ + íƒ€ì´í‹€ í…ìŠ¤íŠ¸)
    if(first && first.type==="title"){
      cur = first;
    }
    document.getElementById("gameTitle").textContent = meta.gameTitle || "My Visual Novel";
    document.getElementById("titleSub").textContent = "";
    applyTitleStyle();
    checkOrient();
    checkSave();
    validate();

    if(first && first.type==="title"){
      // ë°©í–¥ ê³„ì‚° í›„ ë°°ê²½ ì ìš©
      setBg();
      document.getElementById("gameTitle").textContent = first.titleText || (meta.gameTitle || "My Visual Novel");
      document.getElementById("titleSub").textContent = first.subtitleText || "";
    }
  })();
<\/script></body></html>`;
}

/* ===============================
   Visual Maker
=============================== */
function stylePack(key){
  switch(key){
    case "anime_clean": return "clean anime background, crisp linework, high detail, soft global illumination";
    case "anime_pastel": return "pastel anime background, soft shading, gentle bloom, cozy atmosphere";
    case "semi_real": return "semi-realistic background, cinematic lighting, high detail, natural materials";
    case "toon_flat": return "flat toon background, clean shapes, simple shading, strong readability";
    case "pixel_art": return "pixel art background, 16-bit style, detailed tiles, readable shapes";
    default: return "high quality background";
  }
}

function vmNeg(){
  return [
    "people","character","face","hands",
    "watermark","logo",
    "readable text","letters","words","signage"
  ].join(", ");
}

function vmSafePos(){
  return document.querySelector('input[name="vmSafe"]:checked')?.value || "center";
}

function vmBuildPrompt(aspect){
  const place = ($("vmPlace").value||"").trim();
  const tw = ($("vmTime").value||"").trim();
  const obj = ($("vmObj").value||"").trim();
  const mood = ($("vmMood").value||"").trim();
  const style = stylePack($("vmStyle").value);
  const titleFrame = $("vmTitleFrame").checked;
  const safe = vmSafePos();
  const orn = ($("vmOrn").value||"").trim();
  const ornInt = $("vmOrnInt").value || "subtle";

  if(!place) return "";

  const aspectHint = (aspect==="land")
    ? "16:9 landscape, wide establishing shot"
    : "9:16 portrait, vertical composition, keep focal area centered";

  const bits = [];
  if(titleFrame){
    bits.push("Ornamental title card frame background for a visual novel.");
    bits.push(`location theme: ${place}.`);
    if(tw) bits.push(`time/weather vibe: ${tw}.`);
    if(mood) bits.push(`mood: ${mood}.`);
    bits.push(aspectHint + ".");
    bits.push("NO text, NO letters, NO words. Decorative frame only.");
    bits.push(safe==="center"
      ? "Leave a large EMPTY safe area in the CENTER for title text overlay."
      : "Leave a large EMPTY safe area at the TOP for title text overlay.");
    bits.push(`ornament intensity: ${ornInt}.`);
    if(orn) bits.push(`ornament hint: ${orn}.`);
    bits.push("Symmetrical composition, strong readability of empty area.");
    bits.push(style + ".");
  } else {
    bits.push("Background illustration for a visual novel scene (empty background only).");
    bits.push(`location: ${place}.`);
    if(tw) bits.push(`time/weather: ${tw}.`);
    if(mood) bits.push(`mood: ${mood}.`);
    bits.push(aspectHint + ".");
    bits.push("Empty scene: no characters, no people, no readable text, no signage. Clear depth and readable composition.");
    if(obj) bits.push(`key objects: ${obj}.`);
    bits.push(style + ".");
  }
  return bits.join(" ");
}


function vmMockSvg(label, w, h){
  const safe = String(label||"").slice(0,60).replace(/[<>]/g,"");
  const svg = `
  <svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}">
    <defs>
      <linearGradient id="g" x1="0" x2="1">
        <stop offset="0" stop-color="#0f172a"/>
        <stop offset="1" stop-color="#22c55e"/>
      </linearGradient>
    </defs>
    <rect width="100%" height="100%" fill="url(#g)"/>
    <circle cx="80%" cy="30%" r="${Math.round(Math.min(w,h)*0.16)}" fill="rgba(255,255,255,0.12)"/>
    <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
      font-size="${Math.round(Math.min(w,h)*0.06)}" fill="rgba(255,255,255,0.92)"
      font-family="sans-serif">${safe}</text>
    <text x="50%" y="62%" dominant-baseline="middle" text-anchor="middle"
      font-size="${Math.round(Math.min(w,h)*0.028)}" fill="rgba(255,255,255,0.65)"
      font-family="sans-serif">SVG preview (not AI)</text>
  </svg>`;
  return "data:image/svg+xml;utf8," + encodeURIComponent(svg);
}


function vmRender(){
  const genLand = $("vmLand").checked;
  const genPort = $("vmPort").checked;
  const place = ($("vmPlace").value||"").trim();
  const titleFrame = $("vmTitleFrame").checked;
  $("vmOutLandWrap").classList.toggle("hidden", !genLand);
  $("vmOutPortWrap").classList.toggle("hidden", !genPort);

  const land = genLand ? vmBuildPrompt("land") : "";
  const port = genPort ? vmBuildPrompt("port") : "";
  if((genLand && !land) || (genPort && !port)){
    alert("ì¥ì†Œ(í•„ìˆ˜)ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");
    return;
  }
  $("vmOutLand").textContent = land;
  $("vmOutPort").textContent = port;
  $("vmOutNeg").textContent = vmNeg();
  // Optional: SVG preview to quickly confirm layouts (no API)
  const mockOn = $("vmMock") && $("vmMock").checked;
  const landImg = $("vmImgLand"), portImg = $("vmImgPort");
  if(landImg){ landImg.classList.toggle("hidden", !(mockOn && genLand)); if(mockOn && genLand) landImg.src = vmMockSvg((titleFrame? "[TITLE FRAME] ":"[BG] ") + place + " (16:9)", 1600, 900); }
  if(portImg){ portImg.classList.toggle("hidden", !(mockOn && genPort)); if(mockOn && genPort) portImg.src = vmMockSvg((titleFrame? "[TITLE FRAME] ":"[BG] ") + place + " (9:16)", 900, 1600); }
}

function vmCopyAll(){
  const parts = [];
  const land = $("vmOutLand").textContent.trim();
  const port = $("vmOutPort").textContent.trim();
  if(land) parts.push("[LAND 16:9]\n"+land);
  if(port) parts.push("[PORT 9:16]\n"+port);
  parts.push("[NEG]\n"+$("vmOutNeg").textContent.trim());
  navigator.clipboard.writeText(parts.join("\n\n"));
  setStatus("Visual Maker: ì „ì²´ ë³µì‚¬");
}

/* ===============================
   Wire UI
=============================== */
function renderAll(){
  renderSceneList();
  renderEditor();
}

function init(){
  // load autosave
  const saved = localStorage.getItem("vn_onefile_autosave_v1");
  if(saved){
    try{
      const p = JSON.parse(saved);
      if(p && Array.isArray(p.scenes) && p.scenes.length){
        project = p;
        if(!project.settings) project.settings = { font:"sans", titleStyle:"glow", gameTitle:"My Visual Novel" };
        if(String(project.settings.titleStyle||"").toLowerCase()==="neon") project.settings.titleStyle="glow";
        activeSceneId = project.scenes[0].id;
      }
    }catch(e){}
  }

  // sync top
  $("projectName").value = project.name || "MyVN";
  $("gameTitle").value = project.settings?.gameTitle || "My Visual Novel";
  $("fontSel").value = project.settings?.font || "sans";
  $("titleStyleSel").value = project.settings?.titleStyle || "glow";

  // clean illegal states
  cleanPortraitOnlyOnLoad();
  reindexScenes();

  // tabs
  $("tabGame").addEventListener("click", ()=>setTab("game"));
  $("tabVisual").addEventListener("click", ()=>setTab("visual"));

  // top actions
  $("btnAddScene").addEventListener("click", addScene);
  $("btnSaveProject").addEventListener("click", saveProject);
  $("btnNewProject").addEventListener("click", newProject);
  $("btnExportData").addEventListener("click", exportDataJson);

  $("loadProjectFile").addEventListener("change",(e)=>{
    const f = e.target.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = (ev)=>{
      try{
        loadProjectFromText(ev.target.result);
      }catch(err){
        alert("ë¡œë“œ ì˜¤ë¥˜: "+err.message);
      }
    };
    r.readAsText(f);
    e.target.value="";
  });

  // preview
  $("btnPreview").addEventListener("click", openPreview);
  $("btnClosePrev").addEventListener("click", closePreview);
  $("btnReloadPrev").addEventListener("click", reloadPreview);
  $("btnLand").addEventListener("click", ()=>setPreviewMode("landscape"));
  $("btnPort").addEventListener("click", ()=>setPreviewMode("portrait"));

  // settings binds
  bindTopSettings();

  // game inputs
  wireGameInputs();

  // visual maker binds
  $("vmTitleFrame").addEventListener("change", ()=>{
    $("vmTitleOpts").classList.toggle("hidden", !$("vmTitleFrame").checked);
  });

  $("vmBuild").addEventListener("click", vmRender);
  $("vmCopy").addEventListener("click", vmCopyAll);
  $("vmSample").addEventListener("click", ()=>{
    $("vmPlace").value="ë¹„ ì˜¤ëŠ” ê±°ë¦¬";
    $("vmTime").value="ë°¤, ë¹„";
    $("vmObj").value="ê°€ë¡œë“±, ì –ì€ ë³´ë„ë¸”ë¡, ë¹—ë¬¼ ì›…ë©ì´, ë„¤ì˜¨ ë°˜ì‚¬(ë¬¸ì ì—†ëŠ” í˜•íƒœ)";
    $("vmMood").value="ê¸´ì¥";
    $("vmStyle").value="semi_real";
    $("vmLand").checked=true;
    $("vmPort").checked=true;
    $("vmTitleFrame").checked=false;
    $("vmTitleOpts").classList.add("hidden");
    $("vmOutLand").textContent="";
    $("vmOutPort").textContent="";
    $("vmOutNeg").textContent="";
    setStatus("Visual Maker: ìƒ˜í”Œ ì…ë ¥");
  });

  // first render
  renderAll();
  setTab("game");
  // vmRender() ìë™ ì‹¤í–‰ ì œê±°: ì¥ì†Œ ë¯¸ì…ë ¥ ê²½ê³  ë°©ì§€
  setStatus("ë¡œë“œ ì™„ë£Œ");
}
init();
</script>
</body>
</html>
